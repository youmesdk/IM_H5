"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var base64js=require("./base64"),yim=yim||{};yim.OSType="6","undefined"!=typeof wx&&null!=wx||(window.wx=!1),yim.YIMErrorcode={YIMErrorcode_Success:0,YIMErrorcode_EngineNotInit:1,YIMErrorcode_NotLogin:2,YIMErrorcode_ParamInvalid:3,YIMErrorcode_TimeOut:4,YIMErrorcode_StatusError:5,YIMErrorcode_SDKInvalid:6,YIMErrorcode_AlreadyLogin:7,YIMErrorcode_ServerError:8,YIMErrorcode_NetError:9,YIMErrorcode_LoginSessionError:10,YIMErrorcode_NotStartUp:11,YIMErrorcode_FileNotExist:12,YIMErrorcode_SendFileError:13,YIMErrorcode_UploadFailed:14,YIMErrorcode_UsernamePasswordError:15,YIMErrorcode_UserStatusError:16,YIMErrorcode_MessageTooLong:17,YIMErrorcode_ReceiverTooLong:18,YIMErrorcode_InvalidChatType:19,YIMErrorcode_InvalidReceiver:20,YIMErrorcode_UnknowError:21,YIMErrorcode_InvalidAppkey:22,YIMErrorcode_ForbiddenSpeak:23,YIMErrorcode_CreateFileFailed:24,YIMErrorcode_ALREADYFRIENDS:1e3,YIMErrorcode_LoginInvalid:1001,YIMErrorcode_PTT_Start:2e3,YIMErrorcode_PTT_Fail:2001,YIMErrorcode_PTT_DownloadFail:2002,YIMErrorcode_PTT_GetUploadTokenFail:2003,YIMErrorcode_PTT_UploadFail:2004,YIMErrorcode_PTT_NotSpeech:2005,YIMErrorcode_PTT_DeviceStatusError:2006,YIMErrorcode_PTT_IsSpeeching:2007,YIMErrorcode_PTT_FileNotExist:2008,YIMErrorcode_PTT_ReachMaxDuration:2009,YIMErrorcode_PTT_SpeechTooShort:2010,YIMErrorcode_PTT_StartAudioRecordFailed:2011,YIMErrorcode_PTT_SpeechTimeout:2012,YIMErrorcode_Fail:1e4},yim.MessageBodyType={MessageBodyType_Text:0,MessageBodyType_Voice:1,MessageBodyType_File:2,MessageBodyType_Buffer:3},yim.YIMLoginState={YIMLoginState_Init:0,YIMLoginState_Logining:1,YIMLoginState_Success:2,YIMLoginState_Failed:3,YIMLoginState_Logouting:4,YIMLoginState_Reconnect:5},yim.YIMAudioCode={INVOKE_TOOFAST:9001,WAITFOR_LASTINVOKE:9002,INVALID_INVOKE:9003,DUPLICATE_INVOKE:9004,INVOKE_OUTTIME:9005,VOICE_TOOSHORT:9006,WEBRTC_ERROR:9089,INVOKE_ERROR:9090},yim.YIMMessageType={YIMMessageType_Heart:0,YIMMessageType_Login:1,YIMMessageType_Logout:2,YIMMessageType_JoinRoom:3,YIMMessageType_LeaveRoom:4,YIMMessageType_SendMessage:5,YIMMessageType_RecvMessage:6,YIMMessageType_KickOff:7,YIMMessageType_GetUploadToken:8,YIMMessageType_NotifyMsg:9,YIMMessageType_GetMsg:10,YIMMessageType_GetHistoryMsg:11,YIMMessageType_GetWechatToken:12},yim.MessageVoiceType={WEIXIN:1,WEBRTC:2},yim.debug=!1,yim.extend=function(e){for(var t,o,s={}.hasOwnProperty,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(o in t)s.call(t,o)&&(e[o]=t[o])}return e},yim.extendClass=function(e,t){yim.extend(e.prototype,t.prototype||t),e.prototype.constructor=e},yim.isWeixin=function(){return!0},yim.createEvent=function(e,t,o,s){var n={type:e};return n.code=t,n.data=s||{},n.message=o||"",n},yim.loadScript=function(e,t){t=t||"script";var o,s=document.head||document.getElementsByTagName("head")[0]||document.documentElement;return o=document.createElement("script"),o.async=!0,e.charset&&(o.charset=e.charset),o.onload=o.onreadystatechange=function(s,n){(n||!o.readyState||/loaded|complete/.test(o.readyState))&&(o.onload=o.onreadystatechange=null,"jsonp"===t&&o.parentNode&&o.parentNode.removeChild(o),o=null,"script"!==t||n||e.success(200,"success"))},o.src=e.url,s.insertBefore(o,s.firstChild),{abort:function(){o&&o.onload(void 0,!0)}}};var _serialize=function e(t,o){var s,n,i=[];for(var r in t)t.hasOwnProperty(r)&&(s=o?o+"["+r+"]":r,n=t[r],i.push("object"==_typeof(n)?e(n,s):encodeURIComponent(s)+"="+encodeURIComponent(n)));var a=/%20/g;return i.join("&").replace(a,"+")};yim.jsonp=function(e){var t=e.jsonp||"callback",o=e.success||"JSONP_CALLBACK";"function"==typeof o&&(o=e.jsonpCallback||"JSONP_"+(Math.random()+"").substr(2),window[o]=function(){e.success.apply(null,arguments),e.jsonpCallback||(window[o]=null,delete window[o])});var s=e.url,n=t+"="+o,i=e.data||"";return"object"===_typeof(i)&&(i=_serialize(i)),i=i?i+"&"+n:n,i&&(s+=s.indexOf("?")>-1?"&"+i:"?"+i),e.url=s,e.data="",yim.loadScript(e,"jsonp")},yim.log=function(){window.console&&console.log.apply(console,arguments)},yim.trim=function(e){if(!e)return"";var t="".trim;return t?t.call(e):(e+"").replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},yim.indexOf=function(e,t,o){if(o=o||0,e.indexOf)return e.indexOf(t,o);for(var s=e.length;o<s;o++)if(e[o]==t)return o;return-1},yim.each=function(e,t,o){if(e){if(e.forEach)return e.forEach(t,o);var s=e.length;if("number"==typeof s){if(s>0&&s-1 in e)for(var n=0,i=e.length;n<i&&!1!==t.call(o,e[n],n,e);n++);}else for(var r in e)if(e.hasOwnProperty(r)&&!1===t.call(o,e[r],r,e))break}},yim.event=function(){var e=function(){this._listenList={}};return e.prototype={newInstance:function(){return new e},trigger:function(e,t){var o=this,s=Array.prototype.slice.call(arguments,1)||[];return e=e.split(","),yim.each(e,function(e){e=yim.trim(e);var t=o._listenList[e]||[];yim.each(t,function(t,o){var n=s.slice();n.push(e),t.apply(e,n)})}),o},one:function(e,t){return this.off(e),this.on(e,t)},on:function(e,t){var o=this._listenList;return e=e.split(","),yim.each(e,function(e){e=yim.trim(e),o[e]||(o[e]=[]),o[e].push(t)}),this},off:function(e,t){var o=this._listenList;return e=e.split(","),yim.each(e,function(e){if(e=yim.trim(e),!t)return delete o[e];if(o[e]){var s=yim.indexOf(t);return o[e].splice(s,1)}}),!1}},e.prototype.constructor=e,new e}(),yim.getInstance=function(e,t,o,s){function n(){if(!a.socketio.checkConnected||a.socketio.checkConnected()){if(+new Date-a.pingLastTime>3*a.pingInterval)return a.socketio.autoReconnect();a.allMsgQueue.push({serial:++a.msgSerial,data:{base:a.InterGenBase(yim.YIMMessageType.YIMMessageType_Heart,a.msgSerial)}}),a.InterSendMessage()}}var i,r,a=this,c=null;a.strAppKey=t,null!=e&&(a.keywordInstance=new yim.trieInstance(e)),a.eventHandle=yim.event.newInstance(),a.callbacks={},a._socketReady=null,a.ip="",a.port=0,a.msgSerial=0,a.pingInterval=2e4,a.pingLastTime=0,a.getWechatTokenInterval=3e5,a.autoRecvMsg=!0,a.allMsgQueue=[],a.curentSendMsg=null,a.uploadQueue=[],a.curentUpload=null,a.joinRooms={},a._recordMsgInfo={},a.socketio=a.getSocketConnection(t,s),a.socketio.on("connect",function(){a.curentSendMsg=null,a.loginStatus==yim.YIMLoginState.YIMLoginState_Success&&(a.loginStatus=yim.YIMLoginState.YIMLoginState_Reconnect,a._sendMsgData({serial:++a.msgSerial,data:{base:a.InterGenBase(yim.YIMMessageType.YIMMessageType_Login,a.msgSerial,{reconnect:1}),appkey:a.strAppKey,userid:a.strUserID,session:a.strToken}}),a.InterSendMessage()),a._socketReady&&a._socketReady.call(a,a.socketio)}),a.socketio.on("connect_error",function(){yim.debug&&console.log("[yim] connect error"),null!=a.heartTimer&&(clearInterval(a.heartTimer),a.heartTimer=null)}),a.socketio.on("connect_timeout",function(){yim.debug&&console.log("[yim] connect timeout")}),a.socketio.on("disconnect",function(){yim.debug&&console.log("[yim] disconnect"),null!=a.heartTimer&&(clearInterval(a.heartTimer),a.heartTimer=null)}),this.iHeartLossCount=0,this.loginStatus=yim.YIMLoginState.YIMLoginState_Init,null!=o&&(this.callbacks=o),this.uninit=function(){null!=this.curentSendMsg&&null!=this.curentSendMsg.timer&&(clearTimeout(this.curentSendMsg.timer),this.curentSendMsg.timer=null),null!=this.heartTimer&&(clearInterval(this.heartTimer),this.heartTimer=null),this.socketio.disconnect(),this.loginStatus=yim.YIMLoginState.YIMLoginState_Init},this.InterGenBase=function(e,t,o){return{msgtype:+e,version:1,os_type:+yim.OSType,ip:this.ip,port:this.port,seq:""+t,ext:o}},this.setAutoRecvMessage=function(e){this.autoRecvMsg=e},this.getNewMessage=function(){this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_GetMsg,this.msgSerial),msgid:""+this.MaxMessageID}}),this.InterSendMessage()},this.login=function(e,t){if(this.strToken=t||"",this.strUserID=e||"",""==this.strToken||""==this.strUserID)return void(this.callbacks.onLogin&&(c=yim.createEvent("StatusError",yim.YIMErrorcode.YIMErrorcode_ParamInvalid,"参数错误!",{userid:this.strUserID,token:this.strToken}),this.callbacks.onLogin(c.code,c)));wx&&wx.getStorageSync?this.MaxMessageID=Number(wx.getStorageSync(this.strUserID)):this.MaxMessageID=Number(localStorage.getItem(this.strUserID)),isNaN(this.MaxMessageID)&&(this.MaxMessageID=0),this.loginStatus==yim.YIMLoginState.YIMLoginState_Init||this.loginStatus==yim.YIMLoginState.YIMLoginState_Failed?(this.loginStatus=yim.YIMLoginState.YIMLoginState_Logining,this._sendMsgData({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_Login,+new Date),appkey:this.strAppKey,userid:this.strUserID,session:this.strToken,notify:1}})):this.callbacks.onLogin&&(c=yim.createEvent("StatusError",yim.YIMErrorcode.YIMErrorcode_StatusError,"登录状态错误: "+this.loginStatus,{userid:this.strUserID}),c.currentStatus=this.loginStatus,a.callbacks.onLogin(c.code,c))},this.logout=function(){if(this.loginStatus==yim.YIMLoginState.YIMLoginState_Init||this.loginStatus==yim.YIMLoginState.YIMLoginState_Failed)return void(this.callbacks.onLogout&&(c=yim.createEvent("StatusError",yim.YIMErrorcode.YIMErrorcode_StatusError,"当前未登录或登录失败: "+this.loginStatus,{userid:this.strUserID}),c.currentStatus=this.loginStatus,a.callbacks.onLogout(c.code,c)));this.loginStatus=yim.YIMLoginState.YIMLoginState_Logouting,this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_Logout,this.msgSerial)}}),this.InterSendMessage()},this.joinRoom=function(e){var t=e||"";return""==t?void(this.callbacks.onJoinChatRoom&&this.callbacks.onJoinChatRoom(yim.YIMErrorcode.YIMErrorcode_ParamInvalid,t)):this.loginStatus==yim.YIMLoginState.YIMLoginState_Init||this.loginStatus==yim.YIMLoginState.YIMLoginState_Failed?void(this.callbacks.onJoinChatRoom&&(c=yim.createEvent("StatusError",yim.YIMErrorcode.YIMErrorcode_StatusError,"加入房间失败，当前未登录或登录失败: "+this.loginStatus,{roomid:e}),c.currentStatus=this.loginStatus,a.callbacks.onJoinChatRoom(c.code,c))):(this.joinRooms[e]=1,this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_JoinRoom,this.msgSerial),roomid:e}}),void this.InterSendMessage())},this.leaveRoom=function(e){var t=e||"";return""==t?void(this.callbacks.onLeaveChatRoom&&this.callbacks.onLeaveChatRoom(yim.YIMErrorcode.YIMErrorcode_ParamInvalid,t)):this.loginStatus==yim.YIMLoginState.YIMLoginState_Init||this.loginStatus==yim.YIMLoginState.YIMLoginState_Failed?void(a.callbacks.onLeaveChatRoom&&(c=yim.createEvent("StatusError",yim.YIMErrorcode.YIMErrorcode_StatusError,"离开房间失败，当前未登录或登录失败: "+this.loginStatus,{roomid:e}),c.currentStatus=this.loginStatus,a.callbacks.onLeaveChatRoom(c.code,c))):(delete this.joinRooms[e],this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_LeaveRoom,this.msgSerial),roomid:e}}),void this.InterSendMessage())},this.sendTextMessage=function(e,t,o){if("function"==typeof this.socketio.checkConnected&&this.socketio.checkConnected(),this.loginStatus==yim.YIMLoginState.YIMLoginState_Success)return this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_SendMessage,this.msgSerial),receiver:e,chattype:+t,content:o,msgbodytype:yim.MessageBodyType.MessageBodyType_Text}}),this.InterSendMessage(),this.msgSerial},this.sendBufferMessage=function(e,t,o,s){var n=base64js.fromByteArray(new Uint8Array(o));if("function"==typeof this.socketio.checkConnected&&this.socketio.checkConnected(),this.loginStatus==yim.YIMLoginState.YIMLoginState_Success)return this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_SendMessage,this.msgSerial),receiver:e,chattype:+t,content:n,msgbodytype:yim.MessageBodyType.MessageBodyType_Buffer,trantype:s?1:0}}),this.InterSendMessage(),this.msgSerial},this.getHistoryMessage=function(e,t,o,s){if("function"==typeof this.socketio.checkConnected&&this.socketio.checkConnected(),this.loginStatus==yim.YIMLoginState.YIMLoginState_Success)return this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_GetHistoryMsg,this.msgSerial),interlocutor:e,min_msgid:t,max_msgid:o,day_interval:s}}),this.InterSendMessage(),this.msgSerial},this.getWechatToken=function(){return"function"==typeof this.socketio.checkConnected&&this.socketio.checkConnected(),this.loginStatus!==yim.YIMLoginState.YIMLoginState_Success?this.msgSerial:(this.allMsgQueue.push({serial:++this.msgSerial,data:{base:this.InterGenBase(yim.YIMMessageType.YIMMessageType_GetWechatToken,this.msgSerial)}}),this.InterSendMessage(),this.msgSerial)},this.keywordsFilter=function(e){return null==this.keywordInstance?e:this.keywordInstance.GetFilterText(e,"**")},this._sendMsgData=function(e){if(!e)return void console.error("msgData is:"+e);var t=this;e.data.base.msgtype==yim.YIMMessageType.YIMMessageType_Login?(i&&i._loginTimer&&clearTimeout(i._loginTimer),i=e,i._loginTimer=setTimeout(function(){!i._loginStatus&&t.callbacks.onLogin&&(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_TimeOut,"登录超时!",{userid:t.strUserID}),t.callbacks.onLogin(c.code,c))},1e4)):e.data.base.msgtype==yim.YIMMessageType.YIMMessageType_JoinRoom&&(r=e);try{this.socketio.emit("yim",e.data)}catch(e){this.loginStatus=yim.YIMLoginState.YIMLoginState_Failed}},this.InterSendMessage=function(){if(null==this.curentSendMsg&&0!=this.allMsgQueue.length){if("function"==typeof this.socketio.checkConnected&&!this.socketio.checkConnected())return;if(this.loginStatus!=yim.YIMLoginState.YIMLoginState_Success)return;var e=this;this.curentSendMsg=this.allMsgQueue.shift(),this._sendMsgData(this.curentSendMsg),this.curentSendMsg.timer=setTimeout(function(){if(e.curentSendMsg){switch(yim.debug&&console.log("[yim] 发送消息超时:"+JSON.stringify(e.curentSendMsg.data)+" status: "+e.loginStatus),e.curentSendMsg.data.base.msgtype){case yim.YIMMessageType.YIMMessageType_Login:e.callbacks.onLogin&&(null!=e.curentSendMsg.data.base.ext&&1==e.curentSendMsg.data.base.ext.reconnect||(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_TimeOut,"登录超时!",{userid:e.strUserID}),e.callbacks.onLogin(c.code,c))),e.loginStatus=yim.YIMLoginState.YIMLoginState_Failed;break;case yim.YIMMessageType.YIMMessageType_Logout:e.callbacks.onLogout&&(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_TimeOut,"登出超时!",{userid:e.strUserID}),e.callbacks.onLogout(c.code,c)),e.loginStatus=yim.YIMLoginState.YIMLoginState_Init;break;case yim.YIMMessageType.YIMMessageType_JoinRoom:e.callbacks.onJoinChatRoom&&(null!=e.curentSendMsg.data.base.ext&&1==e.curentSendMsg.data.base.ext.reconnect||(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_TimeOut,"加入房间超时!",{roomid:e.curentSendMsg.data.roomid}),e.callbacks.onJoinChatRoom(c.code,c)));break;case yim.YIMMessageType.YIMMessageType_LeaveRoom:e.callbacks.onLeaveChatRoom&&(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_TimeOut,"离开房间超时!",{roomid:e.curentSendMsg.data.roomid}),e.callbacks.onLeaveChatRoom(c.code,c));break;case yim.YIMMessageType.YIMMessageType_SendMessage:e.callbacks.onSendMessageStatus&&(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_TimeOut,"发送消息超时!",{msgid:e.curentSendMsg.serial}),e.callbacks.onSendMessageStatus(c.code,c));break;case yim.YIMMessageType.YIMMessageType_GetUploadToken:e.callbacks.onVoiceMsgSend&&(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_PTT_GetUploadTokenFail,"获取上传票据超时!",{msgID:e.curentSendMsg.serial}),e.callbacks.onVoiceMsgSend(c.code,c),delete e._recordMsgInfo[recordSerial]);break;case yim.YIMMessageType.YIMMessageType_Heart:}e.curentSendMsg=null,e.InterSendMessage()}},1e4)}},this.initVociceMsgAutoPlay=function(e,t){this.initVociceMsgAutoPlay.init||(this.initVociceMsgAutoPlay.init=1)},this.socketio.on("yim",function(e){var t,o=e.base.msgtype,s=!1;switch(o){case yim.YIMMessageType.YIMMessageType_GetHistoryMsg:s=!0;case yim.YIMMessageType.YIMMessageType_GetMsg:for(var l=e.msg_list,d=0,g=l?l.length:0,u=0;u<g;u++){var m={},y=l[u].msgtype;y==yim.MessageBodyType.MessageBodyType_Text?m={history:s,final:u==l.length-1&&l.length<20,last:u==l.length-1,senderid:l[u].sender,recvid:l[u].receiver,chattype:l[u].chattype,messageid:l[u].serial,servermsgid:l[u].svr_msgid,content:l[u].content,createtime:l[u].timespan,msgType:y}:y==yim.MessageBodyType.MessageBodyType_Voice?m={history:s,final:u==l.length-1&&l.length<20,last:u==l.length-1,senderid:l[u].sender,recvid:l[u].receiver,chattype:l[u].chattype,messageid:l[u].serial,servermsgid:l[u].svr_msgid,content:l[u].content,createtime:l[u].timespan,msgType:y,comment:l[u].comment}:y==yim.MessageBodyType.MessageBodyType_Buffer&&(m={senderid:l[u].sender,recvid:l[u].receiver,chattype:l[u].chattype,messageid:l[u].serial,content:base64js.toByteArray(l[u].content),createtime:l[u].timespan,msgType:y,comment:l[u].comment}),!s&&Number(l[u].serial)>d&&(d=Number(l[u].serial)),a.callbacks.onRecvMessage&&a.callbacks.onRecvMessage(m)}d>a.MaxMessageID&&(a.MaxMessageID=d,wx&&wx.setStorageSync?wx.setStorageSync(a.strUserID,d):localStorage.setItem(a.strUserID,d)),l&&0!=l.length&&a.getNewMessage();break;case yim.YIMMessageType.YIMMessageType_NotifyMsg:for(var M=e.args,h=0,I="",u=0;u<M.length;u++){var p=M[u].name,_=M[u].value;"msg_id"==p?h=_:"msg_for"==p&&(I=_)}a.autoRecvMsg?a.getNewMessage():a.callbacks.onReceiveMessageNotify&&a.callbacks.onReceiveMessageNotify(h,I);break;case yim.YIMMessageType.YIMMessageType_GetUploadToken:var f=e.ret,S=e.base.seq;if(0!=f)a.callbacks.onVoiceMsgSend&&(c=yim.createEvent("TimeoutError",yim.YIMErrorcode.YIMErrorcode_PTT_GetUploadTokenFail,"获取上传票据超时!",{msgID:S,_data:e}),a.callbacks.onVoiceMsgSend(c.code,c),delete a._recordMsgInfo[S]);else{var v={token:e.token,downloadurl:e.downloadurl,headers:e.headers,serial:S};a.uploadQueue.push(v),a.InterUpload()}break;case yim.YIMMessageType.YIMMessageType_KickOff:a.callbacks.onKickOff&&a.callbacks.onKickOff(),null!=a.heartTimer&&(clearInterval(a.heartTimer),a.heartTimer=null),a.loginStatus=yim.YIMLoginState.YIMLoginState_Init;break;case yim.YIMMessageType.YIMMessageType_Login:if(t=yim.YIMLoginState.YIMLoginState_Success,e.ret==yim.YIMErrorcode.YIMErrorcode_Success?(a.loginStatus=yim.YIMLoginState.YIMLoginState_Success,a.ip=e.ip,a.msgSerial=e.base.seq||a.msgSerial,a.port=e.port,a.getNewMessage(),a.pingLastTime=+new Date,clearInterval(a.heartTimer),a.heartTimer=setInterval(n,a.pingInterval),a.getWechatToken(),a.getWechatTokenTimer&&clearInterval(a.getWechatTokenTimer),a.getWechatTokenTimer=setInterval(a.getWechatToken.bind(a),a.getWechatTokenInterval)):a.loginStatus=yim.YIMLoginState.YIMLoginState_Failed,i&&(i._loginStatus=a.loginStatus),i&&i._loginTimer&&(clearTimeout(i._loginTimer),i._loginTimer=0),a.callbacks.onLogin&&(i&&i.data.base.ext&&1==i.data.base.ext.reconnect||(c=yim.createEvent("ResultEvent",e.ret,a.loginStatus==t?"ok!":"fail!",{userid:a.strUserID,_data:e}),a.callbacks.onLogin(c.code,c)),i&&i.data&&i.data.base.ext&&1==i.data.base.ext.reconnect)){a.callbacks.onReLogin&&(c=yim.createEvent("ResultEvent",e.ret,a.loginStatus==t?"ok!":"fail!",{userid:a.strUserID,_data:e}),a.callbacks.onReLogin(c.code,c));for(var p in a.joinRooms)null!=a.joinRooms[p]&&(a.allMsgQueue.push({serial:++a.msgSerial,data:{base:a.InterGenBase(yim.YIMMessageType.YIMMessageType_JoinRoom,a.msgSerial,{reconnect:1}),roomid:p}}),a.InterSendMessage())}break;case yim.YIMMessageType.YIMMessageType_Logout:a.callbacks.onLogout&&(c=yim.createEvent("ResultEvent",e.ret,"ok!",{userid:a.strUserID,_data:e}),a.callbacks.onLogout(c.code,c)),null!=a.heartTimer&&(clearInterval(a.heartTimer),a.heartTimer=null),a.loginStatus=yim.YIMLoginState.YIMLoginState_Init;break;case yim.YIMMessageType.YIMMessageType_JoinRoom:a.callbacks.onJoinChatRoom&&(null==a.curentSendMsg?yim.debug&&console.log("[yim] 消息已经超时了，但是服务器又通知了消息"):(r&&r.data.base.ext&&1==r.data.base.ext.reconnect||(c=yim.createEvent("ResultEvent",e.ret,"ok!",{roomid:a.curentSendMsg.data.roomid,_data:e}),a.callbacks.onJoinChatRoom(c.code,c)),r&&r.data.base.ext&&1==r.data.base.ext.reconnect&&a.callbacks.onReJoinChatRoom&&(c=yim.createEvent("ResultEvent",e.ret,"ok!",{roomid:a.curentSendMsg.data.roomid,_data:e}),a.callbacks.onReJoinChatRoom(c.code,c))));break;case yim.YIMMessageType.YIMMessageType_LeaveRoom:a.callbacks.onLeaveChatRoom&&(null==a.curentSendMsg?yim.debug&&console.log("[yim] 消息已经超时了，但是服务器又通知了消息"):(c=yim.createEvent("ResultEvent",e.ret,"ok!",{roomid:a.curentSendMsg.data.roomid,_data:e}),a.callbacks.onLeaveChatRoom(c.code,c)));break;case yim.YIMMessageType.YIMMessageType_SendMessage:a.callbacks.onSendMessageStatus&&(null==a.curentSendMsg?yim.debug&&console.log("[yim] 消息已经超时了，但是服务器又通知了消息"):(c=yim.createEvent("ResultEvent",e.ret,"ok!",{msgid:a.curentSendMsg.serial,_data:e}),a.callbacks.onSendMessageStatus(e.ret,c)));break;case yim.YIMMessageType.YIMMessageType_RecvMessage:if(a.callbacks.onRecvMessage){var m={},y=e.msgbodytype;y==yim.MessageBodyType.MessageBodyType_Text?m={senderid:e.sender,recvid:e.receiver,chattype:e.chattype,messageid:e.serial,content:e.content,createtime:e.timespan,msgType:y}:y==yim.MessageBodyType.MessageBodyType_Voice?m={senderid:e.sender,recvid:e.receiver,chattype:e.chattype,messageid:e.serial,content:e.content,createtime:e.timespan,msgbodytype:e.msgbodytype,msgType:y}:y==yim.MessageBodyType.MessageBodyType_Buffer&&(m={senderid:e.sender,recvid:e.receiver,chattype:e.chattype,messageid:e.serial,content:e.content,createtime:e.timespan,msgbodytype:e.msgbodytype,msgType:y}),a.callbacks.onRecvMessage&&a.callbacks.onRecvMessage(m)}break;case yim.YIMMessageType.YIMMessageType_Heart:a.pingLastTime=+new Date,a.iHeartLossCount=0;break;case yim.YIMMessageType.YIMMessageType_GetWechatToken:yim._wechatToken=e.token}o!=yim.YIMMessageType.YIMMessageType_RecvMessage&&o!=yim.YIMMessageType.YIMMessageType_Login&&(null!=a.curentSendMsg&&(clearTimeout(a.curentSendMsg.timer),a.curentSendMsg=null),a.InterSendMessage())}),this.InterUpload=function(){if(null==this.curentUpload&&0!=this.uploadQueue.length){var e=this;this.curentUpload=this.uploadQueue.shift();var t=this._recordMsgInfo[this.curentUpload.serial].data;wx.uploadFile({url:"https://wxtest3.youme.im/api/uploadmedia/",filePath:t,name:"file",formData:{},success:function(o){var s=JSON.parse(o.data);if(200==o.statusCode){var n=s.downloadurl;yim.debug&&console.log("[yim] voice upload suc!");var i=e.curentUpload.serial,r=e._recordMsgInfo[i].receiver,a=e._recordMsgInfo[i].chattype,c=e._recordMsgInfo[i].comment,l={downloadurl:n,datasize:e._recordMsgInfo[i].datasize,voicetime:e._recordMsgInfo[i].voiceTime,recordmode:yim.MessageVoiceType.WEBRTC};e.allMsgQueue.push({serial:i,data:{base:e.InterGenBase(yim.YIMMessageType.YIMMessageType_SendMessage,i),receiver:r,chattype:a,content:JSON.stringify(l),msgbodytype:yim.MessageBodyType.MessageBodyType_Voice,comment:c}}),e.InterSendMessage();var d=d||e.callbacks.onVoiceMsgSend||function(){};d(yim.YIMErrorcode.YIMErrorcode_Success,{voiceTime:e._recordMsgInfo[i].voiceTime,voiceURL:l.downloadurl,voiceSize:l.datasize,voiceFile:t,msgID:i,comment:c}),delete e._recordMsgInfo[i]}},fail:function(){yim.debug&&console.log("[yim] upload voice error :",event);var t=e.curentUpload.serial;e.callbacks.onVoiceMsgSend&&(c=yim.createEvent("Error",yim.YIMErrorcode.YIMErrorcode_PTT_UploadFail,"Upload Error",{errEvent:event,msgID:t}),e.callbacks.onVoiceMsgSend(c.code,c)),delete e._recordMsgInfo[t]},complete:function(){e.curentUpload=null,e.InterUpload()}})}},this.ready=function(e){this._socketReady=e}},yim.SocketClass=function(e){var t=wx&&wx.connectSocket||e.WebSocket||e.MozWebSocket;this._socketio=null,this._socketConfig={socketio:"https://webim.youme.im/",websocket:"h5.youme.im"};var o={},s=function(e,t){var s=o[e];if(s)for(var n=0,i=s.fnlist.length;n<i;n++)s.fnlist[n].apply(this,t)},n=function(e,t,n){o[t]=o[t]||{bind:!1,fnlist:[]};var i=o[t];i.fnlist.push(n),i.bind||(i.bind=function(){s(t,arguments)},wx&&wx.connectSocket?("open"==t&&e.onOpen(i.bind),"error"==t&&e.onError(i.bind),"close"==t&&e.onClose(i.bind),"message"==t&&e.onMessage(i.bind)):e.addEventListener(t,i.bind))},i=function(e){for(var t in o)o.hasOwnProperty(t)&&(wx&&wx.connectSocket?("open"==t&&e.onOpen(function(){}),"error"==t&&e.onError(function(){}),"close"==t&&e.onClose(function(){}),"message"==t&&e.onMessage(function(){})):e.removeEventListener(t,o[t].bind));o={}},r=function e(){var t=this;if(!(t instanceof e))return new e;t._status="disconnected",t._host="",t._socket=null,t._onConfig={},t._connectTimer=0,t._reconnetTimer=0,t._reconnetNum=0,t._skipReconnect=!1,t._lastConnectTime=0,t._config={timeout:1e4,reconnect:!0,reconnectDelay:5e3},t._event=yim.event.newInstance(),t.on("connect_error,disconnect",function(){yim.debug&&console.log("[yim] get socket disconnect!"),t.autoReconnect()})};r.prototype.close=function(){var e=this,t=1e3;for(i(e._socket);e._socket&&t>0&&e._socket.readyState===this._socket.OPEN;)t-=1,e._socket.close();return e._socket&&e._socket.readyState!==e._socket.OPEN},r.prototype.connect=function(e,o){var s=this;return e&&(s._host=e),s.close(),s._status="connecting",s._skipReconnect=!1,e?s._host=e:e=s._host,s._config=yim.extend(s._config,o||{}),e="ws"!=e.substr(0,2)?"ws://"+e:e,yim.debug&&console.log("[yim] start connect to:"+e),wx&&wx.connectSocket?s._socket=new t({url:e}):s._socket=new t(e),n(s._socket,"open",function(e){s._status="connected",s._reconnetNum=0,clearTimeout(s._reconnetTimer),clearTimeout(s._connectTimer),yim.debug&&console.log("[yim] websocket connected!",e),s._event.trigger("websocket.open,websocket.connect",e)}),n(s._socket,"error",function(e){s._status="disconnected",s._reconnetNum=0,clearTimeout(s._connectTimer),console.error("websocket error!",e),s._event.trigger("websocket.error,websocket.connect_error",e)}),n(s._socket,"close",function(e){s._status="disconnected",s._lastConnectTime=0,clearTimeout(s._connectTimer),yim.debug&&console.log("[yim] websocket close!",e),s._event.trigger("websocket.close,websocket.disconnect",e)}),n(s._socket,"message",function(e){var t=JSON.parse(e.data);yim.debug&&console.log("[yim] receive data:"+JSON.stringify(t)),s._event.trigger("websocket.message",e),s._event.trigger("websocket.yim",t)}),s._connectTimer=setTimeout(function(){s._status="disconnected";var e=yim.createEvent("Error");e.message="WebSocket connect timeout!",console.error(e.message,e),s._event.trigger("websocket.connect_error",e)},s._config.timeout),this},r.prototype.reconnect=function(){var e=this;return e._reconnetNum+=1,yim.debug&&console.log("[yim] start reconnect!"),e.connect(),e},r.prototype.autoReconnect=function(e){var t=this;if("stop"!=t._status){e&&(t._host=e);var o=+new Date;return o-t._lastConnectTime<2e3?void(yim.debug&&console.log("[yim] connect too fast!")):"connecting"===t._status?void(yim.debug&&console.log("[yim] wait for connect!")):(t._lastConnectTime=o,yim.debug&&console.log("[yim] start auto reconnect!"),clearTimeout(t._reconnetTimer),!(!t._config.reconnect||t._skipReconnect)&&(t._reconnetTimer=setTimeout(t.reconnect.bind(t),t._reconnetNum>0?t._config.reconnectDelay:100),t))}},r.prototype.disconnect=function(){var e=this;return e._status="stop",e._skipReconnect=!0,e._socket&&e.close(),e},r.prototype.on=function(e,t){var o=this;return e=e.split(","),yim.each(e,function(e,s){o._event.on("websocket."+e,t)}),this},r.prototype.off=function(e,t){return this._event.off("websocket."+e,t),this},r.prototype.checkConnected=function(){var e=this;if(!e._socket||e._socket.readyState==this._socket.CLOSED){var t=yim.createEvent("error",yim.YIMErrorcode.YIMErrorcode_NetError,"WebSocket disconnect!",{msg:"WebSocket disconnect!"});return e._event&&e._event.trigger("websocket.connect_error",t),!1}return!0},r.prototype.isConnected=function(){var e=this;return e._socket&&e._socket.readyState===e._socket.OPEN},r.prototype.emit=function(e,t){var o=this,s=JSON.stringify(t);if(yim.debug&&console.log("[yim] send key:"+e+"; send data:"+s),!o._socket||o._socket.readyState!==o._socket.OPEN)throw new Error("WebSocket disconnect!");return o._event.trigger("websocket.send",e,s,t),o._socket.send({data:s}),o},this.getSocketConnection=function(e,o){if(t&&!o){var s="wss://"+e.substr(e.length-8).toLowerCase()+"."+this._socketConfig.websocket;this._socketio=r().connect(s)}else this._socketio=io.connect(this._socketConfig.socketio);return this._socketio}},yim.extendClass(yim.getInstance,new yim.SocketClass(window)),yim.trieInstance=function(e){this.root={},this.root.childNodes={};for(var t=0;t<e.length;t++){for(var o=e[t],s=this.root,n=0;n<o.length;n++){var i=o.charAt(n),r=s.childNodes[i];null==r&&(r={childNodes:{}},s.childNodes[i]=r),s=r}s.finish=1}this.GetFilterText=function(e,t){for(var o="",s=this.root,n=-1,i=0;i<e.length;){var r=e.charAt(i),a=s.childNodes[r];null!=a?(-1==n&&(n=i),s=a,1==s.finish&&(s=this.root,n=-1,o+=t),i++):-1!=n?(o+=e.charAt(n),i=n+1,n=-1,s=this.root):(o+=e.charAt(i),i++)}return-1!=n&&(o+=e.substr(n,e.length-n+1)),o}},yim.MediaInterface=function(){this._supportAudioMessage=!1,this._mediaConfig={maxRecordSecond:60,showProgressTips:1,minInvokeInterval:2,mediaConstraints:{audio:!0}},this.startAudioMessage=function(e,t){},this.stopAudioMessage=function(){},this.cancelAudioMessage=function(){},this.playAudioMessage=function(){},this.initAutoPlayVoiceQueue=function(e){},this.addToAutoPlayVoiceQueue=function(e){},this.getSupportAudioMessage=function(){return this._supportAudioMessage};this.initAudioMedia=function(e,t){t=t||function(){},"function"==typeof e&&(t=e,e={});var o=this;e=e||{},yim.extend(this._mediaConfig,e),this._mediaConfig.maxRecordSecond=Math.min(parseInt(this._mediaConfig.maxRecordSecond,10),60),this._mediaConfig.maxRecordSecond<1&&(this._mediaConfig.maxRecordSecond=60),yim.isWeixin()?(yim.extendClass(yim.getInstance,new yim.WeixinMedia),this.initWeixinRecord(this._mediaConfig,function(e){t.call(o,{type:"weixin",support:e})})):(yim.extendClass(yim.getInstance,new yim.AmrMedia),this.initAmrRecord(this._mediaConfig,function(e){t.call(o,{type:"webrtc",support:e})}))}},yim.extendClass(yim.getInstance,new yim.MediaInterface),yim.WeixinMedia=function(){var e,t,o,s=0,n=-1,i="",r={},a=[],c="",l={},d=0,g=null,u=wx.getRecorderManager(),m=wx.createInnerAudioContext(),y=!1;m.autoplay=!1,m.loop=!1,m.onPlay(function(){console.log("开始播放"),e.eventHandle.trigger("voiceplay.start",{})}),m.onError(function(t){console.log("playerror"),e.eventHandle.trigger("voiceplay.cancel",t);var s=g?g._wxcontent.downloadurl:i;o(yim.YIMErrorcode.YIMErrorcode_Fail,{localId:s,curPlayMsg:g})}),m.onStop(function(){console.log("播放停止"),e.eventHandle.trigger("voiceplay.stop",{});var t=g?g._wxcontent.downloadurl:i;o(yim.YIMErrorcode.YIMErrorcode_Success,{localId:t,curPlayMsg:g})}),m.onEnded(function(){console.log("播放完毕"),e.eventHandle.trigger("voiceplay.stop",{});var t=g?g._wxcontent.downloadurl:i;o(yim.YIMErrorcode.YIMErrorcode_Success,{localId:t,curPlayMsg:g})}),u.onStart(function(){console.log("recorder start"),s=+new Date,e.eventHandle.trigger("voicerecord.start",{})}),u.onResume(function(){console.log("recorder resume")}),u.onPause(function(){console.log("recorder pause")}),u.onError(function(o){console.log("recorder onError"),e.eventHandle.trigger("voicerecord.cancel",{}),t(yim.YIMErrorcode.YIMErrorcode_Fail,o),t=null,n=-1}),u.onStop(function(o){y||(console.log("recorder stop",o),e.eventHandle.trigger("voicerecord.stop",{localId:o.tempFilePath}),h.call(e,o.tempFilePath,Math.ceil(o.duration/1e3)),t(yim.YIMErrorcode.YIMErrorcode_Success,o),t=null,n=-1)}),u.onFrameRecorded(function(e){var t=e.frameBuffer;console.log("frameBuffer.byteLength",t.byteLength)});var M={duration:6e4,sampleRate:44100,numberOfChannels:1,encodeBitRate:64e3,format:"aac",frameSize:500};this._sendAudioFile=function(e,t,o){var s=this;s._recordMsgInfo=s._recordMsgInfo||{},s._recordMsgInfo[e].data=t,
s._recordMsgInfo[e].voiceTime=o,wx.getFileInfo({filePath:t,digestAlgorithm:"md5",success:function(t){s._recordMsgInfo[e].datasize=t.size,s.allMsgQueue.push({serial:e,data:{base:s.InterGenBase(yim.YIMMessageType.YIMMessageType_GetUploadToken,e,{Serial:e}),filesize:t.size,filemd5:t.digest,filename:e.toString()}}),s.InterSendMessage()},fail:function(){console.error("getFileInfo Fail:"+t)}})};var h=function(e,t){var o=this,s=s||o.callbacks.onVoiceMsgSend;o._sendAudioFile(n,e,t)},I=function(e,t){t=t||this._mediaConfig.minInvokeInterval,t=t||1;var o=+new Date;return!(o-(l[e]||0)<1e3*t)&&(l[e]=o,o)};this.startAudioMessage=function(o,s,i,r){var a=this;return e=this,t=r||function(){},I.call(a,"startRecord")?(y=!1,-1!==n&&(u.stop(),console.warn("[yim] last invoke not complete!")),d=0,n=++this.msgSerial,this._recordMsgInfo[n]={receiver:o,chattype:s,msgbodytype:yim.MessageBodyType.MessageBodyType_Voice,comment:i},a.eventHandle.trigger("voicerecord.beforestart",{}),u.start(M),n):t(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.INVOKE_TOOFAST,errMsg:"调用录音接口太快，请等待"+a._mediaConfig.minInvokeInterval+"s重试"})};var p=function(e){var t=this;return-1==n?(e(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.INVALID_INVOKE,errMsg:"未调用开始录音，无需停止！"}),!1):d?(e(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.DUPLICATE_INVOKE,errMsg:"已调用停止录音，重复调用！"}),!1):(d=n,u.stop(),e(yim.YIMErrorcode.YIMErrorcode_Success,{errCode:0,curPlayMsg:g}),y&&t.eventHandle.trigger("voicerecord.cancel",{localId:-1,curPlayMsg:g}),d)};this.stopAudioMessage=function(t){var o=this;e=this,t=t||function(){};new Date;return p.call(o,t)},this.cancelAudioMessage=function(t){var o=this;return e=this,t=t||function(){},y=!0,p.call(o,t)},this.playAudioURL=function(e){m.paused||m.stop(),m.src=e,m.play(),console.warn("not support")},this.playAudioMessage=function(t,s,n){var r=this;if(e=this,o=n||function(){},!I.call(r,"startPlay",1))return o(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.INVOKE_TOOFAST,errMsg:"调用播放录音接口太快，请等待1s重试"});if(!(t=t||i))return o(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.INVOKE_ERROR,errMsg:"mediaID invalid!"});var a={serverId:t,curPlayMsg:g};r.eventHandle.trigger("voiceplay.beforestart",a),m.paused||m.stop(),m.obeyMuteSwitch=!1,m.autoplay=!0,m.startTime=0,m.src=t,m.play(),i=t};var _=function(){m.stop()};this.stopPlayAudioMessage=function(t){var o=this;if(e=this,t=t||function(){},!I.call(o,"stopPlay",1))return t(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.INVOKE_TOOFAST,errMsg:"调用停止播放接口太快，请等待1s重试"});_.call()};var f=function(e,t){var o=this;t=t||function(){},o.eventHandle.trigger("voiceplay.beforepause",{localId:e,curPlayMsg:g}),yim.debug&&console.log("[yim]invoke wx.pauseVoice:"+e),m.pause()};this.pausePlayAudioMessage=function(t,o){var s=this;if(e=this,o=o||function(){},!I.call(s,"pausePlay",1))return o(yim.YIMErrorcode.YIMErrorcode_Fail,{errCode:yim.YIMAudioCode.INVOKE_TOOFAST,errMsg:"调用停止播放接口太快，请等待1s重试"});t=t||i,f.call(this,r[t],o)};var S=0,v="",T=function(){var e=this;if(!(a.length<1)&&"playing"!=c&&"recording"!=c){if(g&&g._endtimer&&(clearTimeout(g._endtimer),g._endtimer=0),null==(g=a.shift())||void 0===g)return void console.warn("_currentPlayMsg is null");g._endtimer=setTimeout(function(){e.eventHandle.trigger("voicerecord.cancel",{localId:null,curPlayMsg:g})},1e3*g._wxcontent.voicetime),yim.debug&&console.log("[yim] start auto play:"+g._wxcontent.mediaid,g),this.playAudioMessage(JSON.parse(g.content).downloadurl,g._wxcontent.voicetime,function(t,o){t!=yim.YIMErrorcode.YIMErrorcode_Success&&(yim.debug&&console.warn("yim play error:",o),e.eventHandle.trigger("voicerecord.cancel",{localId:null,curPlayMsg:g}))})}};this.addToAutoPlayVoiceQueue=function(t){e=this;var o=t.content;if("string"==typeof o&&(o="{"==o.charAt(0)?JSON.parse(o):{mediaid:o}),t._wxcontent=o,!t._wxcontent.downloadurl)return void console.error("[autovoice] msg content error!",t);a.push(t),yim.debug&&console.log("[yim] [autovoice] add msg to play queue!",t),a.length>200&&a.splice(0,50),T.call(this)},this.initAutoPlayVoiceQueue=function(t){t=t||{};var o=this;e=this,o.initAutoPlayVoiceQueue=function(){},o.eventHandle.on("voicerecord.beforestart",function(e){clearTimeout(S);var t=c;c="recording","playing"==t&&_.call()}),o.eventHandle.on("voicerecord.stop, voicerecord.cancel",function(e){c="",v="",clearTimeout(S),S=setTimeout(function(){T.call(o)},100)}),o.eventHandle.on("voiceplay.beforestart",function(e){c="playing"}),o.eventHandle.on("voiceplay.start",function(e){c="playing",v=e.localId,e.curPlayMsg&&t.beginPlay&&t.beginPlay.call(o,e.curPlayMsg)});var s=function(e,s){return"recording"!=c&&(c="",v=""),t.endPlay&&s&&g._endtimer&&t.endPlay.call(o,s),s&&(clearTimeout(g._endtimer),s._endtimer=0),yim.debug&&console.log("[yim] [voiceplay] msg play end!",s),s};o.eventHandle.on("voiceplay.cancel, voiceplay.beforestop, voiceplay.beforepause",function(e){s(e.localId)}),o.eventHandle.on("voiceplay.stop",function(e){c="",s(e.localId),clearTimeout(S),S=setTimeout(function(){T.call(o)},100)})},this.initWeixinRecord=function(e,t){var o=this,s=yim.createEvent("ResultEvent",yim.YIMErrorcode.YIMErrorcode_Success,"ok!",{support:!0});o._supportAudioMessage=!0,t.call(o,o._supportAudioMessage,s)}},"undefined"!=typeof module&&(module.exports=yim);