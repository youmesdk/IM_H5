!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.YIM=n()}(this,function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])};function t(t,n){function i(){this.constructor=t}r(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=i;function i(){}i.mixin=function(t){var n=t.prototype||t;n.isWildEmitter=!0,n.on=function(t,n,i){this.callbacks=this.callbacks||{};var r=3===arguments.length,e=r?n:void 0,s=r?i:n;return s.t=e,(this.callbacks[t]=this.callbacks[t]||[]).push(s),this},n.once=function(n,t,i){var r=this,e=3===arguments.length,s=e?t:void 0,o=e?i:t;return this.on(n,s,function t(){r.off(n,t),o.apply(this,arguments)}),this},n.releaseGroup=function(t){var n,i,r,e;for(n in this.callbacks=this.callbacks||{},this.callbacks)for(i=0,r=(e=this.callbacks[n]).length;i<r;i++)e[i].t===t&&(e.splice(i,1),i--,r--);return this},n.off=function(t,n){this.callbacks=this.callbacks||{};var i,r=this.callbacks[t];return r&&(1===arguments.length?delete this.callbacks[t]:-1!==(i=r.indexOf(n))&&(r.splice(i,1),0===r.length&&delete this.callbacks[t])),this},n.emit=function(t){this.callbacks=this.callbacks||{};var n,i,r,e=[].slice.call(arguments,1),s=this.callbacks[t],o=this.getWildcardCallbacks(t);if(s)for(n=0,i=(r=s.slice()).length;n<i&&r[n];++n)r[n].apply(this,e);if(o)for(i=o.length,n=0,i=(r=o.slice()).length;n<i&&r[n];++n)r[n].apply(this,[t].concat(e));return this},n.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var n,i,r=[];for(n in this.callbacks)i=n.split("*"),("*"===n||2===i.length&&t.slice(0,i[0].length)===i[0])&&(r=r.concat(this.callbacks[n]));return r}},i.mixin(i);var e,s=(t(o,e=n),o.prototype.set=function(t,n){this.n[t]=n,this.emit("change:"+t,t,n)},o.prototype.get=function(t){return this.n[t]},o);function o(){var t=e.call(this)||this;return t.n={appKey:"",userId:"",token:""},t}var u,h=(t(f,u=n),f.prototype.login=function(t,n,i){var r=this;return this.i?n!==this.r?(this.logout(),new Promise(function(t){setTimeout(function(){return t()},100)}).then(function(){return r.login(t,n,i)})):Promise.resolve():(this.e=!0,this.s.set("appKey",t),this.s.set("userId",n),this.s.set("token",i),this.o=t,this.r=n,this.u=i,this.emit("logging"),this.h.send(1,{appkey:t,userid:n+"",session:i+"",notify:1,base:{os_type:this.f,ip:"",port:0}}).then(function(){r.e=!1,r.i=!0,r.emit("login")}).catch(function(t){throw r.e=!1,r.i=!1,r.h.close(),r.emit("error:"+t.name,t),t}))},f.prototype.logout=function(){this.h.close(),this.i=!1,this.emit("logout")},f.prototype.isLogging=function(){return this.e},f.prototype.isLogged=function(){return this.i},f.prototype.doIfLogged=function(){var e=this;return new Promise(function(t,n){if(e.i)t();else{var i=setTimeout(function(){e.off("login",r);var t=new Error;t.name="NotLoginError",n(t)},1e4),r=function(){t(),clearTimeout(i)};e.once("login",r)}})},f.prototype.getMyUserId=function(){return this.r},f.prototype.reconnect=function(){var t=this;return this.i=!1,this.h.doWhenSigingReady().then(function(){return t.login(t.o,t.r,t.u)})},f);function f(t,n){var i=u.call(this)||this;return i.s=t,i.h=n,i.e=!1,i.i=!1,i.o="",i.r="",i.u="",i.f=6,i.h.on("message:7",function(){i.h.close(),i.i=!1,i.emit("kickoff")}),i}var c,a=(t(v,c=n),v.prototype.joinRoom=function(n){var i=this;return n+="",this.c[n]||(this.c[n]=[this.s.get("userId")]),this.emit("joining:"+n,n),this.h.send(3,{roomid:n}).then(function(t){return i.emit("join:"+n,n),n}).catch(function(t){throw i.emit("join-error:"+t.name,t,n),delete i.c[n],t})},v.prototype.leaveRoom=function(n){var i=this;return n+="",this.h.send(4,{roomid:n}).then(function(){delete i.c[n],i.emit("leave:"+n,n)}).catch(function(t){throw i.emit("leave-error:"+t.name,t,n),t})},v.prototype.leaveAllRoom=function(){for(var t=[],n=0,i=Object.keys(this.c);n<i.length;n++){var r=i[n];t.push(this.leaveRoom(r))}return Promise.all(t).then(function(){})},v.prototype.clear=function(){for(var t=0,n=Object.keys(this.c);t<n.length;t++){var i=n[t];this.emit("leave:"+i,i)}this.c={}},v.prototype.doIfJoinedRoom=function(n){var i=this;return new Promise(function(t){n+="",i.inRoom(n)?t():i.once("join:"+n,function(){return t()})})},v.prototype.inRoom=function(t){return t+="",!!this.c[t]},v.prototype.getRoomIdList=function(){return Object.keys(this.c)},v.prototype.reconnect=function(){var r=this;this.h.doWhenSigingReady().then(function(){for(var t=0,n=r.getRoomIdList();t<n.length;t++){var i=n[t];r.h.send(3,{roomid:i}).then()}})},v);function v(t,n){var i=c.call(this)||this;return i.s=t,i.h=n,i.c={},i.h.on("status:ended",function(){return i.clear()}),i}function l(t){return t?"wss://"+t.substr(t.length-8).toLowerCase()+".h5.youme.im:443":""}var d,m="wss://webrtctest.youme.im",w="disconnected",y="connected",g="reconnecting",p="ended",b={0:"OK",20001:"NotLoginError",20002:"InvalidParamError",20003:"InvalidLoginError",20004:"UsernameOrTokenError",20005:"LoginTimeoutError",20006:"ServiceOverloadError",20007:"MessageTooLongError"},E=(t(A,d=n),A.prototype.init=function(t){return(t=t||l(this.s.get("appKey")))&&(this.a=t,this.v(),this.l("connecting")),this},A.prototype.send=function(i,t){var r=this;if(this.d!==w&&this.d!==p||(this.init(),this.d!==w&&this.d!==p))return this.m++,t.base=t.base||{},t.base=Object.assign(t.base,{msgtype:i,seq:this.m+"",version:this.w,os_type:this.f}),this.y.push(t),this.g(),this.p&&clearTimeout(this.p),this.p=setTimeout(function(){return r.b()},2e4),new Promise(function(t,n){r.A[r.m]=t,r.k[r.m]=n,r.T[i]=r.m});var n=new Error;return n.name="NotLoginError",Promise.reject(n)},A.prototype.getStatus=function(){return this.d},A.prototype.close=function(){this.l(p),this.j&&(this.j.close(),this.j=null),this.y=[],this.A={},this.m=0,this.p&&(clearTimeout(this.p),this.p=0)},A.prototype.checkNetwork=function(){var i=this;return new Promise(function(t,n){i.P.push(t),i.I.push(n),i.S||i.b()})},A.prototype.v=function(){var t=this;this.j&&this.j.close(),console.log("start connect"),"undefined"!=typeof uni&&uni.connectSocket?this.j=uni.connectSocket({url:this.a,success:function(){console.log("connectSocket success")},fail:function(){console.log("connectSocket fail")},complete:function(){console.log("connectSocket complete")}}):(console.log("connectSocket"),this.j=new WebSocket(this.a)),this.once("ready",function(){t.O()}),this.x()},A.prototype.B=function(){var t=this;if(!this.C){if(this.C=!0,this.d!==p){if(this.d!==g){for(var n in this.k)this.k.hasOwnProperty(n)&&this.k[n](new DOMException("Socket was closed.","NetworkError"));this.A={},this.k={},this.l(g)}this.j=null,setTimeout(function(){t.d===g&&(t.v(),t.C=!1)},2e3)}this.p&&(clearTimeout(this.p),this.p=0),this.U&&(clearInterval(this.U),this.U=0)}},A.prototype.x=function(){var u=this;console.log("socketEvent:"+this.j),this.j&&("undefined"!=typeof uni?(this.j.onOpen(function(t){console.log("WebSocket连接已打开"),u.l(y),u.emit("ready"),u.g()}),this.j.onError(function(t){console.log("WebSocket连接打开失败"),u.emit("error",t)}),this.j.onClose(function(t){console.log("WebSocket连接已关闭")})):(this.j.addEventListener("open",function(){u.l(y),u.emit("ready"),u.g()}),this.j.addEventListener("error",function(t){u.B(),u.emit("error",t)}),this.j.addEventListener("close",function(){u.B()}),this.j.addEventListener("message",function(t){var n=JSON.parse(t.data),i=n.ret,r=n.base,e=r.msgtype,s=r.seq;if((s=s||u.T[e])&&u.A[s]){if(i&&"0"!==i){var o=new Error;o.name=b[i]||"Error-"+i,u.k[s](o)}else u.A[s](n);delete u.A[s],delete u.k[s]}u.emit("message:"+e,n)})))},A.prototype.doWhenSigingReady=function(){var n=this;return new Promise(function(t){if(n.getStatus()===y)return t();n.once("ready",function(){t()})})},A.prototype.l=function(t){this.d!==t&&(this.d=t,this.emit("status:"+t,t))},A.prototype.g=function(){if(this.d===y&&this.j){for(var t=0,n=this.y;t<n.length;t++){var i=n[t];"undefined"!=typeof uni?this.j.send({data:JSON.stringify(i)}):this.j.send(JSON.stringify(i));var r=i.base;this.emit("send:"+r.msgtype,i)}this.y=[]}},A.prototype.O=function(){var t=this;this.U&&(clearInterval(this.U),this.U=0),this.U=setInterval(function(){t.S||t.send(0,{}).catch(function(){})},6e4),this.once("status:"+p,function(){t.U&&(clearInterval(t.U),t.U=0)}),this.once("status:"+g,function(){t.U&&(clearInterval(t.U),t.U=0)})},A.prototype.b=function(){var t=this;if(!this.S){this.S=!0;var n=setTimeout(function(){t.N(!1),t.j&&t.j.close(),t.B()},1e4);this.send(0,{}).then(function(){clearTimeout(n),t.N(!0)}).catch(function(){clearTimeout(n),t.N(!1)})}},A.prototype.N=function(t){if(t)for(var n=0,i=this.P;n<i.length;n++){var r=i[n];r&&r()}else for(var e=0,s=this.I;e<s.length;e++){var o=s[e];o&&o()}this.P=[],this.I=[],this.S=!1},A);function A(t){var n=d.call(this)||this;return n.s=t,n.w=1,n.f=6,n.j=null,n.a=m,n.d=w,n.y=[],n.A={},n.k={},n.T={},n.S=!1,n.P=[],n.I=[],n.m=Date.now(),n.p=0,n.U=0,n.C=!1,n}var k="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var T,j,P=(function(p){!function(){var f="input is invalid type",t="object"==typeof window,n=t?window:{};n.JS_MD5_NO_WINDOW&&(t=!1);var i=!t&&"object"==typeof self,r=!n.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;r?n=k:i&&(n=self);var e,s=!n.JS_MD5_NO_COMMON_JS&&p.exports,c=!n.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,o="0123456789abcdef".split(""),u=[128,32768,8388608,-2147483648],a=[0,8,16,24],h=["hex","array","digest","buffer","arrayBuffer","base64"],v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),l=[];if(c){var d=new ArrayBuffer(68);e=new Uint8Array(d),l=new Uint32Array(d)}!n.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),!c||!n.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});function m(n){return function(t){return new y(!0).update(t)[n]()}}var w=function(n){var i=[eval][0]("require('crypto')"),r=[eval][0]("require('buffer').Buffer");return function(t){if("string"==typeof t)return i.createHash("md5").update(t,"utf8").digest("hex");if(null==t)throw f;return t.constructor===ArrayBuffer&&(t=new Uint8Array(t)),Array.isArray(t)||ArrayBuffer.isView(t)||t.constructor===r?i.createHash("md5").update(new r(t)).digest("hex"):n(t)}};function y(t){if(t)l[0]=l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0,this.blocks=l,this.buffer8=e;else if(c){var n=new ArrayBuffer(68);this.buffer8=new Uint8Array(n),this.blocks=new Uint32Array(n)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}y.prototype.update=function(t){if(!this.finalized){var n,i=typeof t;if("string"!=i){if("object"!=i)throw f;if(null===t)throw f;if(c&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||c&&ArrayBuffer.isView(t)))throw f;n=!0}for(var r,e,s=0,o=t.length,u=this.blocks,h=this.buffer8;s<o;){if(this.hashed&&(this.hashed=!1,u[0]=u[16],u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),n)if(c)for(e=this.start;s<o&&e<64;++s)h[e++]=t[s];else for(e=this.start;s<o&&e<64;++s)u[e>>2]|=t[s]<<a[3&e++];else if(c)for(e=this.start;s<o&&e<64;++s)(r=t.charCodeAt(s))<128?h[e++]=r:(r<2048?h[e++]=192|r>>6:(r<55296||57344<=r?h[e++]=224|r>>12:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++s)),h[e++]=240|r>>18,h[e++]=128|r>>12&63),h[e++]=128|r>>6&63),h[e++]=128|63&r);else for(e=this.start;s<o&&e<64;++s)(r=t.charCodeAt(s))<128?u[e>>2]|=r<<a[3&e++]:(r<2048?u[e>>2]|=(192|r>>6)<<a[3&e++]:(r<55296||57344<=r?u[e>>2]|=(224|r>>12)<<a[3&e++]:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++s)),u[e>>2]|=(240|r>>18)<<a[3&e++],u[e>>2]|=(128|r>>12&63)<<a[3&e++]),u[e>>2]|=(128|r>>6&63)<<a[3&e++]),u[e>>2]|=(128|63&r)<<a[3&e++]);this.lastByteIndex=e,this.bytes+=e-this.start,64<=e?(this.start=e-64,this.hash(),this.hashed=!0):this.start=e}return 4294967295<this.bytes&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},y.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,n=this.lastByteIndex;t[n>>2]|=u[3&n],56<=n&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},y.prototype.hash=function(){var t,n,i,r,e,s,o=this.blocks;n=this.first?((n=((t=((t=o[0]-680876937)<<7|t>>>25)-271733879<<0)^(i=((i=(-271733879^(r=((r=(-1732584194^2004318071&t)+o[1]-117830708)<<12|r>>>20)+t<<0)&(-271733879^t))+o[2]-1126478375)<<17|i>>>15)+r<<0)&(r^t))+o[3]-1316259209)<<22|n>>>10)+i<<0:(t=this.h0,n=this.h1,i=this.h2,((n+=((t=((t+=((r=this.h3)^n&(i^r))+o[0]-680876936)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[1]-389564586)<<12|r>>>20)+t<<0)&(t^n))+o[2]+606105819)<<17|i>>>15)+r<<0)&(r^t))+o[3]-1044525330)<<22|n>>>10)+i<<0),n=((n+=((t=((t+=(r^n&(i^r))+o[4]-176418897)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[5]+1200080426)<<12|r>>>20)+t<<0)&(t^n))+o[6]-1473231341)<<17|i>>>15)+r<<0)&(r^t))+o[7]-45705983)<<22|n>>>10)+i<<0,n=((n+=((t=((t+=(r^n&(i^r))+o[8]+1770035416)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[9]-1958414417)<<12|r>>>20)+t<<0)&(t^n))+o[10]-42063)<<17|i>>>15)+r<<0)&(r^t))+o[11]-1990404162)<<22|n>>>10)+i<<0,n=((n+=((t=((t+=(r^n&(i^r))+o[12]+1804603682)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[13]-40341101)<<12|r>>>20)+t<<0)&(t^n))+o[14]-1502002290)<<17|i>>>15)+r<<0)&(r^t))+o[15]+1236535329)<<22|n>>>10)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[1]-165796510)<<5|t>>>27)+n<<0)^n))+o[6]-1069501632)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[11]+643717713)<<14|i>>>18)+r<<0)^r))+o[0]-373897302)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[5]-701558691)<<5|t>>>27)+n<<0)^n))+o[10]+38016083)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[15]-660478335)<<14|i>>>18)+r<<0)^r))+o[4]-405537848)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[9]+568446438)<<5|t>>>27)+n<<0)^n))+o[14]-1019803690)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[3]-187363961)<<14|i>>>18)+r<<0)^r))+o[8]+1163531501)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[13]-1444681467)<<5|t>>>27)+n<<0)^n))+o[2]-51403784)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[7]+1735328473)<<14|i>>>18)+r<<0)^r))+o[12]-1926607734)<<20|n>>>12)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[5]-378558)<<4|t>>>28)+n<<0))+o[8]-2022574463)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[11]+1839030562)<<16|i>>>16)+r<<0))+o[14]-35309556)<<23|n>>>9)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[1]-1530992060)<<4|t>>>28)+n<<0))+o[4]+1272893353)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[7]-155497632)<<16|i>>>16)+r<<0))+o[10]-1094730640)<<23|n>>>9)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[13]+681279174)<<4|t>>>28)+n<<0))+o[0]-358537222)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[3]-722521979)<<16|i>>>16)+r<<0))+o[6]+76029189)<<23|n>>>9)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[9]-640364487)<<4|t>>>28)+n<<0))+o[12]-421815835)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[15]+530742520)<<16|i>>>16)+r<<0))+o[2]-995338651)<<23|n>>>9)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[0]-198630844)<<6|t>>>26)+n<<0)|~i))+o[7]+1126891415)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[14]-1416354905)<<15|i>>>17)+r<<0)|~t))+o[5]-57434055)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[12]+1700485571)<<6|t>>>26)+n<<0)|~i))+o[3]-1894986606)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[10]-1051523)<<15|i>>>17)+r<<0)|~t))+o[1]-2054922799)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[8]+1873313359)<<6|t>>>26)+n<<0)|~i))+o[15]-30611744)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[6]-1560198380)<<15|i>>>17)+r<<0)|~t))+o[13]+1309151649)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[4]-145523070)<<6|t>>>26)+n<<0)|~i))+o[11]-1120210379)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[2]+718787259)<<15|i>>>17)+r<<0)|~t))+o[9]-343485551)<<21|n>>>11)+i<<0,this.first?(this.h0=t+1732584193<<0,this.h1=n-271733879<<0,this.h2=i-1732584194<<0,this.h3=r+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+n<<0,this.h2=this.h2+i<<0,this.h3=this.h3+r<<0)},y.prototype.toString=y.prototype.hex=function(){this.finalize();var t=this.h0,n=this.h1,i=this.h2,r=this.h3;return o[t>>4&15]+o[15&t]+o[t>>12&15]+o[t>>8&15]+o[t>>20&15]+o[t>>16&15]+o[t>>28&15]+o[t>>24&15]+o[n>>4&15]+o[15&n]+o[n>>12&15]+o[n>>8&15]+o[n>>20&15]+o[n>>16&15]+o[n>>28&15]+o[n>>24&15]+o[i>>4&15]+o[15&i]+o[i>>12&15]+o[i>>8&15]+o[i>>20&15]+o[i>>16&15]+o[i>>28&15]+o[i>>24&15]+o[r>>4&15]+o[15&r]+o[r>>12&15]+o[r>>8&15]+o[r>>20&15]+o[r>>16&15]+o[r>>28&15]+o[r>>24&15]},y.prototype.array=y.prototype.digest=function(){this.finalize();var t=this.h0,n=this.h1,i=this.h2,r=this.h3;return[255&t,t>>8&255,t>>16&255,t>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,255&i,i>>8&255,i>>16&255,i>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255]},y.prototype.buffer=y.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),n=new Uint32Array(t);return n[0]=this.h0,n[1]=this.h1,n[2]=this.h2,n[3]=this.h3,t},y.prototype.base64=function(){for(var t,n,i,r="",e=this.array(),s=0;s<15;)t=e[s++],n=e[s++],i=e[s++],r+=v[t>>>2]+v[63&(t<<4|n>>>4)]+v[63&(n<<2|i>>>6)]+v[63&i];return t=e[s],r+=v[t>>>2]+v[t<<4&63]+"=="};var g=function(){var n=m("hex");r&&(n=w(n)),n.create=function(){return new y},n.update=function(t){return n.create().update(t)};for(var t=0;t<h.length;++t){var i=h[t];n[i]=m(i)}return n}();s?p.exports=g:n.md5=g}()}(T={exports:{}},T.exports),T.exports),I=(P.hex,P.array,P.digest,P.arrayBuffer,P.buffer,P.create),S=(P.update,P.base64,t(O,j=n),O.prototype.setContent=function(t){this.__content="string"==typeof t?t:JSON.stringify(t),this.__isReady=!0;for(var n=0,i=this.__onReadyQueue;n<i.length;n++)(0,i[n])(this.__content);this.__onReadyQueue=[]},O.prototype.setExtraParam=function(t){this.__extraParam="string"==typeof t?t:JSON.stringify(t)},O.prototype.setCanceled=function(){this.__isCanceled=!0;for(var t=0,n=this.__onCancelQueue;t<n.length;t++){var i=n[t],r=new Error("Message Canceled.");r.name="CanceledError",i(r)}this.__onCancelQueue=[]},O.prototype.uploadFile=function(h){var f=this;return new Promise(function(s,o){var e,u=new FileReader;u.onload=function(){if(!(e=u.result)){var t=new Error;return t.name="UploadFileError",o(t)}var n=I();function i(i){var r=new XMLHttpRequest;r.ontimeout=function(t){o(t)},r.onerror=function(t){o(t)},r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var t=i.downloadUrl,n=t.indexOf(":");-1<n&&n<7&&(t=t.substr(n+1)),s(t)}};var t=i.uploadUrl,n=t.indexOf(":");for(var e in-1<n&&n<7&&(t=t.substr(n+1)),r.open("PUT",t,!0),r.timeout=6e4,i.headers)"host"!==e&&i.headers.hasOwnProperty(e)&&r.setRequestHeader(e,i.headers[e]);r.send(h)}n.update(e);var r=n.hex();f.__reqUpTk?f.__reqUpTk(h.size,r,r,h.type.split("/")[1]).then(i).catch(function(t){return o(t)}):O.__gControls.reqUpTk?O.__gControls.reqUpTk(h.size,r,r,h.type.split("/")[1]).then(i).catch(function(t){return o(t)}):new Promise(function(t){f.__onSetUpTkFn.push(t)}).then(function(){f.__reqUpTk(h.size,r,r,h.type.split("/")[1]).then(i).catch(function(t){return o(t)})})},u.readAsArrayBuffer(h)})},O.prototype.requestWechatToken=function(){var n=this;return this.__reqWXTk?this.__reqWXTk():O.__gControls.reqWXTk?O.__gControls.reqWXTk():new Promise(function(t){n.__onSetWXTkFn.push(t)}).then(function(){return n.__reqWXTk()})},O.prototype.isReady=function(){return this.__isReady},O.prototype.isCanceled=function(){return this.__isCanceled},O.prototype.onReady=function(t,n){if(this.__isReady)return t();this.__isCanceled?n&&n():this.__waitForContent().then(function(){t()}).catch(function(t){"CanceledError"===t.name&&n&&n()})},O.prototype.getContent=function(){var t;if(this.__isCanceled)throw(t=new Error("Message Canceled.")).name="CanceledError",t;if(this.__isReady)return this.__content;throw(t=new Error("Content is not ready yet.")).name="ContentNotReadyError",t},O.prototype.getExtraParam=function(){return this.__extraParam},O.prototype.getTypeId=function(){return this.typeId},O.prototype.getType=function(){return this.typeName},O.prototype.__onReqUpTk=function(t){this.__reqUpTk=t;for(var n=0,i=this.__onSetUpTkFn;n<i.length;n++)(0,i[n])();this.__onSetUpTkFn=[]},O.prototype.__onReqWXTk=function(t){this.__reqWXTk=t;for(var n=0,i=this.__onSetWXTkFn;n<i.length;n++)(0,i[n])();this.__onSetWXTkFn=[]},O.prototype.__waitForContent=function(){var i=this;if(this.__isReady)return Promise.resolve(this.__content);if(this.__isCanceled){var t=new Error("Message Canceled.");return t.name="CanceledError",Promise.reject(t)}return new Promise(function(t,n){i.__onReadyQueue.push(t),i.__onCancelQueue.push(n)})},O.__gControls={},O);function O(){var i=null!==j&&j.apply(this,arguments)||this;return i.__isReady=!1,i.__isCanceled=!1,i.__reqUpTk=null,i.__reqWXTk=null,i.__onReadyQueue=[],i.__onCancelQueue=[],i.__onSetUpTkFn=[],i.__onSetWXTkFn=[],i.__content="",i.__extraParam="",i.typeId=0,i.__controls={initWithContent:function(t,n){return i.initWithContent(t,n).then(function(){return i.setContent(t)})},getContent:function(){return i.getContent()},getTypeId:function(){return i.getTypeId()},getType:function(){return i.getType()},onRequestUploadToken:function(t){return i.__onReqUpTk(t)},onRequestWechatToken:function(t){return i.__onReqWXTk(t)},waitForContent:function(){return i.__waitForContent()}},i}var x,B=(t(C,x=n),C.prototype.registerMessageType=function(t){var n=new t,i=n.__controls.getTypeId(),r=n.__controls.getType();0===i&&"text"!==r?this.M[r]=t:this._[i]=t},C.prototype.sendToRoom=function(i,r){var e=this;return i+="",this.D(r).then(function(n){var t=C.J(i,"group",n);return e.L(t).then(function(t){var n=e.q(i,"group",t.svr_msgid,r);return e.F(n),e.emit("send:group:"+i,n),n}).catch(function(t){throw e.emit("send-failed:"+t.name+":group:"+i+":"+t.name,n,t),t})})},C.prototype.sendToUser=function(i,r){var e=this;return this.D(r).then(function(n){var t=C.J(i,"user",n);return e.L(t).then(function(t){var n=e.q(i,"user",t.svr_msgid,r);return e.F(n),e.emit("send:user:"+i,n),n}).catch(function(t){throw e.emit("send-failed:"+t.name+":user:"+i,n,t),t})})},C.prototype.requestHistoryMessage=function(t,n,i,r){var o=this;return this.h.send(11,{interlocutor:t,min_msgid:n,max_msgid:i,day_interval:r}).then(function(t){for(var n=[],i=0,r=t.msg_list;i<r.length;i++){var e=r[i],s=o.W(e);n.push(s)}return n})},C.prototype.clear=function(){this.R={},this.K={},this.z.clear()},C.prototype.H=function(t){function n(t){var n=s.W(t),i=n.withPeer,r=n.chatType;s.F(n)&&s.D(n.message).then(function(){e.emit("receive:"+r+":"+i,n)})}for(var e=this,i=t.msg_list,s=this,r=0,o=i;r<o.length;r++)n(o[r])},C.prototype.W=function(t){var n,i=this,r=t.sender,e=t.receiver,s=t.sender===this.s.get("userId");if(t&&1==t.msgtype&&t.comment&&!t.comment.h5){var o=t.content;/^https:/i.test(o)&&(o=o.replace(/^https:/i,"")),t.content=JSON.stringify({datasize:parseInt(t.comment.FileSize),downloadurl:o,voicetime:t.comment.Time,AudioText:t.comment?t.comment.AudioText:"",comment:t.comment,recordmode:2,extra:t.comment.Param})}switch(t.chattype){case 1:default:n="user";break;case 2:n="group"}var u,h=new Date(1e3*t.timespan),f=t.msgtype,c=t.content;if(0===f){var a=c.match(/^(.+?)!/),v=a?a[1]:null;u=v?(c=c.replace(/^(.+?)!/,""),this.M[v]):this._[0]}else u=this._[f];if(!u){var l=new Error;throw l.name="MessageTypeMissingError",l}var d=new u,m=t&&t.comment&&t.comment.AttachParam?t.comment.AttachParam:"";return!m&&t&&t.comment&&t.comment.Param&&(m=t.comment.Param),d.__controls.initWithContent(c,m).catch(function(t){i.emit("error:"+t.name,t)}),{senderId:r,receiverId:e,withPeer:s||"group"===n?e:r,isFromMe:s,chatType:n,time:h,serial:t.serial,serverId:t.svr_msgid,message:d}},C.J=function(t,n,i){var r,e;switch(n){case"user":default:r=1;break;case"group":r=2}if(e=0===i.getTypeId()&&"text"!==i.getType()?i.getType()+"!"+i.getContent():i.getContent(),"text"===i.getType())return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{AttachParam:i.getExtraParam()}};if("voice"!==i.getType())return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{AttachParam:i.getExtraParam()}};var s=JSON.parse(e);return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{h5:"true",Param:s.extra+"",FileSize:s.datasize+"",Time:parseInt(s.voicetime)+""}}},C.prototype.q=function(t,n,i,r){return{senderId:this.s.get("userId"),receiverId:t,withPeer:t,isFromMe:!0,chatType:n,time:new Date,serverId:i,message:r}},C.prototype.F=function(t){if(this.z.has(t.serverId))return!1;var n=t.withPeer;switch(t.chatType){case"group":for(this.K[n]=this.K[n]||[],this.K[n].push(t),this.z.add(t.serverId);30<this.K[n].length;)(i=this.K[n].shift())&&this.z.delete(i.serverId);break;case"user":for(this.R[n]=this.R[n]||[],this.R[n].push(t),this.z.add(t.serverId);30<this.R[n].length;){var i;(i=this.R[n].shift())&&this.z.delete(i.serverId)}}return!0},C.prototype.L=function(t){return this.h.send(5,t)},C.prototype.D=function(t){var e=this;return t.__controls.onRequestUploadToken(function(t,n,i,r){return e.X(t,n,i,r)}),t.__controls.onRequestWechatToken(function(){return e.G()}),t.__controls.waitForContent().then(function(){return t}).catch(function(t){throw"CanceledError"===t.name&&e.emit("error:"+t.name,t),t})},C.prototype.X=function(t,n,i,r){return this.h.send(8,{filename:i,filesize:t,filemd5:n,filesuffix:r}).then(function(t){return{headers:t.headers,uploadUrl:t.token,downloadUrl:t.downloadurl}})},C.prototype.G=function(){var n=this,t=+new Date-+this.Q;return this.V&&t<3e5?Promise.resolve(this.V):this.h.send(12,{}).then(function(t){return n.V=t.token,n.Q=new Date,n.V})},C);function C(t,n){var i=x.call(this)||this;return i.s=t,i.h=n,i.R={},i.K={},i.z=new Set,i._={},i.M={},i.V="",i.Q=new Date(0),i.h.on("message:9",function(t){if(t&&"object"==typeof t.args){var n=0;n=t.args.msg_for?0:parseInt(t.args.msg_id)-1,i.h.send(10,{msgid:n+""}).then(function(t){i.H(t)})}}),S.__gControls.reqUpTk=i.X.bind(i),S.__gControls.reqWXTk=i.G.bind(i),i}var U;function N(t){var n=U.call(this)||this;return n.o="",n.s=new s,n.h=new E(n.s),n.Y=new h(n.s,n.h),n.Z=new a(n.s,n.h),n.$=new B(n.s,n.h),n.tt(),n.nt(),n.it(),n.rt(),n.et(),t&&n.init(t).then(),console.log("ver:",N.VERSION),n}return t(N,U=n),N.prototype.init=function(t){var n=[];if(this.o=t.appKey,t.userId&&t.token&&n.push(this.login(t.userId+"",t.token,!0).then(function(){})),t.roomId){t.roomId instanceof Array||(t.roomId=[t.roomId]);for(var i=0,r=t.roomId;i<r.length;i++){var e=r[i];n.push(this.joinRoom(e).then(function(){}))}}return t.useMessageType&&this.registerMessageType(t.useMessageType),t.userId&&t.token?Promise.all(n).then(function(){}):Promise.resolve()},N.prototype.uninit=function(){this.logout()},N.prototype.login=function(t,n,i){return void 0===i&&(i=!1),this.Y.login(this.o,""+t,n).catch(function(t){if(!i)throw t})},N.prototype.logout=function(){this.Z.clear(),this.$.clear(),this.Y.logout()},N.prototype.isLogging=function(){return this.Y.isLogging()},N.prototype.isLogged=function(){return this.Y.isLogged()},N.prototype.getMyUserId=function(){return this.Y.getMyUserId()},N.prototype.joinRoom=function(t){var n=this;return this.Y.doIfLogged().then(function(){return n.Z.joinRoom(t)})},N.prototype.leaveRoom=function(t){var n=this;return this.Y.doIfLogged().then(function(){return t?n.Z.leaveRoom(t):n.Z.leaveAllRoom()})},N.prototype.inRoom=function(t){return this.Z.inRoom(t)},N.prototype.getRoomIdList=function(){return this.Z.getRoomIdList()},N.prototype.registerMessageType=function(t){if(t instanceof Array)for(var n=0,i=t;n<i.length;n++){var r=i[n];this.$.registerMessageType(r)}else this.$.registerMessageType(t)},N.prototype.sendToRoom=function(t,n,i){var r=this;return void 0===i&&(i=!1),this.Y.doIfLogged().then(function(){return r.Z.doIfJoinedRoom(t+"")}).then(function(){return r.$.sendToRoom(t+"",n)}).catch(function(t){if(!i&&(i=!0,!n.isCanceled()))throw t})},N.prototype.sendToUser=function(t,n,i){var r=this;return void 0===i&&(i=!1),this.Y.doIfLogged().then(function(){return r.$.sendToUser(t+"",n)}).catch(function(t){if(!i&&(i=!0,!n.isCanceled()))throw t})},N.prototype.requestHistoryMessage=function(t,n,i,r){return this.$.requestHistoryMessage(t,n,i,r)},N.prototype.tt=function(){var t=this;this.h.on("status:reconnecting",function(){return t.Y.reconnect().then(function(){return t.Z.reconnect()})})},N.prototype.nt=function(){var i=this;this.Y.on("login",function(){return i.emit("account.login")}),this.Y.on("logging",function(){return i.emit("account.logging")}),this.Y.on("logout",function(){return i.emit("account.logout")}),this.Y.on("kickoff",function(){return i.emit("account.kickoff")}),this.Y.on("error:*",function(t,n){return i.emit("account."+t,n)})},N.prototype.it=function(){var r=this;this.Z.on("join:*",function(t,n){return r.emit("room.join:"+n,n)}),this.Z.on("joining:*",function(t,n){return r.emit("room.joining:"+n,n)}),this.Z.on("leave:*",function(t,n){return r.emit("room.leave:"+n,n)}),this.Z.on("join-error:*",function(t,n,i){return r.emit("room.join-error:"+n.name,n,i)}),this.Z.on("leave-error:*",function(t,n,i){return r.emit("room.leave-error:"+n.name,n,i)})},N.prototype.rt=function(){var r=this;this.$.on("send:*",function(t,n){return r.emit("message:send:"+n.chatType+":"+n.withPeer,n)}),this.$.on("send-failed:*",function(t,n,i){return r.emit("message:"+t,n,i)}),this.$.on("receive:*",function(t,n){return r.emit("message:receive:"+n.chatType+":"+n.withPeer,n)})},N.prototype.et=function(){var i=this;this.h.on("status:*",function(t,n){return i.emit("signaling.status:"+n,n)}),this.h.on("ready",function(){return i.emit("signaling.ready")}),this.h.on("message:*",function(t,n){return i.emit("signaling.receive:"+n.base.msgtype,n)}),this.h.on("send:*",function(t,n){return i.emit("signaling.send:"+n.base.msgtype,n)}),this.h.on("error",function(t){return i.emit("signaling.error",t)})},N.VERSION="2.0.14",N.Message=S,N.WildEmitter=n,N});
