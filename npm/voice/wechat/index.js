!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("youme-h5-im/voice")):"function"==typeof define&&define.amd?define(["youme-h5-im/voice"],t):n.WechatRecorder=t(n.VoiceMessage)}(this,function(n){n=n&&n.hasOwnProperty("default")?n.default:n;var t,i,o,r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};function e(){this.constructor=t}function s(){var n=null!==o&&o.apply(this,arguments)||this;return n.n="",n.t="",n.i=0,n.o=0,n.r=!1,n.e=!1,n.s=!1,n.u=function(){},n.c=function(){},n.f=function(){},n.typeId=1,n.typeName="wechat",n}return o=n.Recorder,r(t=s,i=o),void(t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)),s.h=function(){var o=this;if(this.a)return Promise.resolve();if(this.l)return new Promise(function(n,t){o.m.push(n),o.v.push(t),300<o.m.length&&(o.m.unshift(),o.v.unshift())});var i=this.d;if(i)return this.l=!0,new Promise(function(n){i.ready(function(){n()})}).then(function(){return new Promise(function(u,c){var f=["startRecord","stopRecord","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice"];i.checkJsApi({jsApiList:f,success:function(n){if(!n||!n.checkResult)return(t=new Error).name="WXObjectNoConfigError",void c(t);for(var t,i=n.checkResult,o=[],r=0,e=f;r<e.length;r++){var s=e[r];i[s]||o.push(s)}if(o.length)return(t=new Error).name="WXNoPermissionError",void c(t);u()}})})}).then(function(){return new Promise(function(n,t){i.startRecord({success:function(){setTimeout(function(){i.stopRecord({success:function(){},complete:function(){setTimeout(function(){return n()},100)}})},200)},fail:function(){var n=new Error;n.name="NotAllowedError",t(n)}})})}).then(function(){o.a=!0,o.l=!1;for(var n=0,t=o.m;n<t.length;n++)(0,t[n])();return o.m.splice(0,333),o.v.splice(0,333),o.d.onVoiceRecordEnd({complete:function(n){o.w&&o.p.call(o.w,n)}}),o.d.onVoicePlayEnd({success:function(n){o.P.call(o.y,n)}}),Promise.resolve()}).catch(function(n){for(var t=0,i=o.v;t<i.length;t++)(0,i[t])(n);throw n});var n=new Error;return n.name="WXObjectIsEmptyError",Promise.reject(n)},s.b=function(t,n,i){var o=this;if(this.w){var r=new Error("Recorder is busy.");throw r.name="RecorderBusyError",r}this.y&&this.j(),this.w=n,this.p=i,this.T=!0,this.d.startRecord(Object.assign({},t,{success:function(n){t&&t.success&&t.success(n),setTimeout(function(){o.T=!1},900)}}))},s.g=function(){var t=this;this.T?setTimeout(function(){return t.g()},500):this.d.stopRecord({success:function(n){t.w&&t.p.call(t.w,n),t.w=null,t.p=function(){}}})},s.O=function(n,t,i){var o=this;if(this.y)return this.j(),void setTimeout(function(){return o.O(n,t,i)},100);this.d.playVoice(n),this.y=t,this.V=n,this.P=i},s.j=function(){this.d.stopVoice(this.V),this.y&&this.P.call(this.y),this.y=null,this.V={},this.P=function(){}},s.D=function(n){var i=this;return new Promise(function(t){i.d.downloadVoice({serverId:n,isShowProgressTips:0,success:function(n){t(n.localId||"")}})})},s.I=function(n){var i=this;return new Promise(function(t){i.d.uploadVoice({localId:n,isShowProgressTips:0,success:function(n){t(n.serverId)}})})},s.setWXObject=function(n){this.d=n},s.isWechat=function(){return!!navigator.userAgent.toLowerCase().match(/micromessenger/i)},s.prototype.isEnvSupport=function(){return s.isWechat()},s.prototype.isSupportMsg=function(n){return"object"==typeof n&&"string"==typeof n.mediaid&&0<n.mediaid.length},s.prototype.initRecord=function(){return s.h().then(function(){})},s.prototype.startRecord=function(){var i=this;return this.o=+new Date,new Promise(function(n,t){s.b({success:function(){i.o=+new Date,n()}},i,i.R),i.r=!0,i.s=!1})},s.prototype.finishRecord=function(){var i=this;return new Promise(function(n,t){i.c=n,s.g(),i.i=(+new Date-i.o)/1e3})},s.prototype.cancelRecord=function(){this.s=!0,s.g()},s.prototype.isRecording=function(){return this.r},s.prototype.onRecordEnd=function(n){this.u=n},s.prototype.getJsonMsg=function(){return{voicetime:this.getDuration().toFixed(2),mediaid:this.t,recordmode:this.getTypeId()}},s.prototype.initWithJsonMsg=function(n){var t=this;return this.i=n.voicetime,this.t=n.mediaid,s.h().then(function(){return s.D(t.t)}).then(function(n){t.n=n})},s.prototype.play=function(){s.O({localId:this.n},this,this._),this.e=!0,s.y=this},s.prototype.stop=function(){s.j(),this.e=!1,s.y=null},s.prototype.isPlaying=function(){return this.e},s.prototype.onPlayEnd=function(n){this.f=n},s.prototype.getDuration=function(){return this.i},s.prototype._=function(){this.e=!1,this.f()},s.prototype.R=function(n){var t=this,i=n.localId;this.s||(this.i=this.i<.1?(+new Date-this.o)/1e3:this.i,s.I(i).then(function(n){t.n=i,t.t=n,t.c(),t.u(),t.c=function(){},t.r=!1}))},s.d=null,s.a=!1,s.l=!1,s.T=!1,s.m=[],s.v=[],s.w=null,s.y=null,s.V={},s});
