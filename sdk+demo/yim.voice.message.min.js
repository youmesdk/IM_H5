!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("youme-im/core")):"function"==typeof define&&define.amd?define(["youme-im/core"],i):t.VoiceMessage=i(t.YIM)}(this,function(t){t=t&&t.hasOwnProperty("default")?t.default:t;var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)i.hasOwnProperty(r)&&(t[r]=i[r])};var i=function(){function t(){var n=this;this.__uploadFn=null,this.__onSetUploadFn=[],this.__getWXTkFn=null,this.__onSetWXTkFn=[],this.__controls={setUploadFunc:function(t){n.__uploadFn=t;for(var i=0,r=n.__onSetUploadFn;i<r.length;i++){(0,r[i])()}n.__onSetUploadFn=[]},setWechatTokenFunc:function(t){n.__getWXTkFn=t;for(var i=0,r=n.__onSetWXTkFn;i<r.length;i++){(0,r[i])()}n.__onSetWXTkFn=[]}}}return t.prototype.getTypeId=function(){return this.typeId},t.prototype.getType=function(){return this.typeName},t.prototype.uploadFile=function(t){var i=this;return this.__uploadFn?this.__uploadFn(t):new Promise(function(t){i.__onSetUploadFn.push(t)}).then(function(){return i.__uploadFn(t)})},t.prototype.requestWechatToken=function(){var i=this;return this.__getWXTkFn?this.__getWXTkFn():new Promise(function(t){i.__onSetWXTkFn.push(t)}).then(function(){return i.__getWXTkFn()})},t}();return function(r){function o(t){var i=r.call(this)||this;return i.t="",i.typeId=1,i.typeName="voice",i.i=null,i.r=null,i.n=!1,void(i.s=0)!==t&&i.setExtra(t),i}return function(t,i){function r(){this.constructor=t}n(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}(o,r),o.prototype.setExtra=function(t){void 0!==t&&(this.t=t.toString())},o.prototype.getExtra=function(){return this.t},o.registerRecorder=function(t){for(var i=0,r=t;i<r.length;i++){var n=r[i],s=new n;s.isEnvSupport()&&(this.o.push(n),this.h.push(s))}},o.isEnvSupport=function(){return!!this.o.length},o.initRecorder=function(){return(new o).initRecord()},o.e=function(){var t=this;if(this.u[0]){var i=this.u[0];this.c.emit("begin-play",i),i.play(),i.on("end-play",function(){t.c.emit("end-play",i),t.u.shift(),t.u[0]&&t.c.emit("next",t.u[0]),t.e()})}else this.c.emit("all-ended")},o.addToAutoPlayQueue=function(t){this.u.push(t),this.c.emit("add",t),1===this.u.length&&this.e()},o.getAutoPlayQueueLength=function(){return this.u.length},o.getCurrentAutoPlayingMessage=function(){return this.u[0]},o.nextAutoPlay=function(){this.u.length&&(this.u[0].stop(),this.u.shift(),this.u[0]&&this.c.emit("next",this.u[0]),this.e())},o.stopAndClearAutoPlayQueue=function(){this.u.length&&(this.u[0].stop(),this.u=[],this.e())},o.bindAutoPlayEvent=function(t,i){this.c.on(""+t,i)},o.unbindAutoPlayEvent=function(t,i){this.c.off(""+t,i)},o.prototype.initWithContent=function(i){var r,t=this;try{r=JSON.parse(i)}catch(t){r=i}for(var n=0,s=o.o.length;n<s;n++)if(o.h[n].isSupportMsg(r))return this.i=new o.o[n],this.i.__controls.setUploadFunc(this.uploadFile.bind(this)),this.i.__controls.setWechatTokenFunc(this.requestWechatToken.bind(this)),this.i.initWithJsonMsg(r).then(function(){t.i.onPlayEnd(function(){t.emit("end-play")}),"object"==typeof r&&t.setExtra(r.extra),t.setContent(i)});return this.r=new Error("Unsupported voice message format."),this.r.name="UnsupportedVoiceFormatError",Promise.reject(this.r)},o.prototype.initRecord=function(){return o.isEnvSupport()?this.isReady()?(this.r=new Error,this.r.name="AlreadyReadyError"):this.isCanceled()&&(this.r=new Error,this.r.name="CanceledError"):(this.r=new Error,this.r.name="DeviceNotSupportedError"),this.r?(this.emit("error:"+this.r.name,this.r),Promise.reject(this.r)):this.i?Promise.resolve():(this.i=new o.o[0],this.i.__controls.setUploadFunc(this.uploadFile.bind(this)),this.i.__controls.setWechatTokenFunc(this.requestWechatToken.bind(this)),this.i.initRecord().catch(function(t){throw"NotSupportedError"===t.name&&(t.name="DeviceNotSupportedError"),t}))},o.prototype.startRecord=function(i){var r=this;return void 0===i&&(i=!1),this.n=!0,this.isCanceled()?(this.r=new Error,this.r.name="CanceledError",i?Promise.resolve():Promise.reject(this.r)):(this.r=null,this.initRecord().then(function(){if(!r.isCanceled())return r.i.onPlayEnd(function(){r.emit("end-play")}),r.i.onRecordEnd(function(){var t=r.i.getJsonMsg(),i=Object.assign({},t,{extra:r.t});r.setContent(i),r.emit("finish-record")}),r.i.startRecord()}).then(function(){if(r.isError()){if(r.i&&r.i.cancelRecord(),i)return;throw r.r}r.s=setTimeout(function(){r.n=!1},1e3),r.emit("start-record")}).catch(function(t){if(r.r=t,r.emit("error:"+t.name,t),r.cancelRecord(),!i)throw r.r}))},o.prototype.finishRecord=function(i){var r=this;return void 0===i&&(i=!1),this.r||(this.i?this.isCanceled()&&(this.r=new Error,this.r.name="CanceledError"):(this.r=new Error,this.r.name="RecorderNotStartedError")),this.r?(this.emit("error:"+this.r.name),i?Promise.resolve():Promise.reject(this.r)):this.n?(this.i&&this.i.cancelRecord(),this.setCanceled(),this.r=new Error,this.r.name="RecordTooShortError",this.emit("error:"+this.r.name),clearTimeout(this.s),i?Promise.resolve():Promise.reject(this.r)):(this.emit("finishing-record"),this.i.finishRecord().catch(function(t){if(r.setCanceled(),(r.r=t)&&t.name&&r.emit("error:"+t.name),!i)throw t}))},o.prototype.cancelRecord=function(){this.i&&this.i.cancelRecord(),this.setCanceled(),this.emit("cancel-record")},o.prototype.isRecording=function(){return!!this.i&&this.i.isRecording()},o.prototype.isError=function(){return!!this.r},o.prototype.getErrorName=function(){return this.r?this.r.name:""},o.prototype.play=function(){var t=this;this.onReady(function(){t.i.play(),t.emit("play")})},o.prototype.stop=function(){this.isReady()&&this.i&&this.i.isPlaying()&&(this.i.stop(),this.emit("stop"))},o.prototype.isPlaying=function(){return!!this.i&&this.i.isPlaying()},o.prototype.getDuration=function(){return this.i?this.i.getDuration():0},o.o=[],o.h=[],o.Recorder=i,o.u=[],o.c=new t.WildEmitter,o}(t.Message)});
